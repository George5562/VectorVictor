# $maxN (aggregation accumulator) - MongoDB Manual v8.0


Docs Home / MongoDB Manual / Aggregation Operations / Reference / Operators $maxN (aggregation accumulator) On this page Definition Syntax Behavior Restrictions Examples Definition $maxN New in version 5.2 . Returns an aggregation of the maxmimum value n elements within a
group. If the group contains fewer than n elements, $maxN returns all elements in the group. Syntax { $maxN: { input: <expression>, n: <expression> } } input specifies an expression that is the input to $maxN . It
is evaluated for each element in the group and $maxN preserves the
maximum n values. n limits the number of results per group and n has to be a
positive integral expression that is either a constant or depends on
the _id value for $group . Behavior Result Type $maxN compares input data following the BSON Comparison order to
determine the appropriate output type. When the input data contains
multiple data types, the $maxN output type is the highest in the comparison order. Null and Missing Values $maxN filters out null and missing values. Consider the following aggregation that returns the maximum n documents from a group: db. aggregate ( [ { $documents : [ { playerId : "PlayerA" , gameId : "G1" , score : 1 } , { playerId : "PlayerB" , gameId : "G1" , score : 2 } , { playerId : "PlayerC" , gameId : "G1" , score : 3 } , { playerId : "PlayerD" , gameId : "G1" } , { playerId : "PlayerE" , gameId : "G1" , score : null } ] } , { $group : { _id : "$gameId" , maximumThreeScores : { $maxN : { input : "$score" , n : 4 } } } } ] ) In this example: $documents creates the literal documents that contain
player scores. $group groups the documents by gameId . This
example has only one gameId , G1 . PlayerD has a missing score and PlayerE has a
null score . These values are both considered as null. The maximumThreeScores field is specified as $maxN with input : "$score" and returned as an array. Since there are only 3 documents with scores maxN returns the
maximum 3 score fields even though n = 4 . [ { _id : 'G1' , maximumThreeScores : [ 3 , 2 , 1 ] } ] Comparison of $maxN and $topN Accumulators Both $maxN and $topN accumulators can accomplish similar
results. In general: $maxN has the advantage of finding maximum values
in no particular sort order. If you want to know the
maximum values for n documents use $maxN . If guaranteing a particular sort order is a requirement
use $topN . Use $topN if you don't intend on sorting on the output
values. Restrictions Window Function and Aggregation Expression Support You can use $maxN as an accumulator. $maxN is supported as an aggregation expression . $maxN is supported as a window operator . Memory Limit Considerations Aggregation pipelines which call $maxN are subject to the 100 MB limit . If this
limit is exceeded for an individual group, the aggregation fails
with an error. Examples Consider a gamescores collection with the following documents: db. gamescores . insertMany ( [ { playerId : "PlayerA" , gameId : "G1" , score : 31 } , { playerId : "PlayerB" , gameId : "G1" , score : 33 } , { playerId : "PlayerC" , gameId : "G1" , score : 99 } , { playerId : "PlayerD" , gameId : "G1" , score : 1 } , { playerId : "PlayerA" , gameId : "G2" , score : 10 } , { playerId : "PlayerB" , gameId : "G2" , score : 14 } , { playerId : "PlayerC" , gameId : "G2" , score : 66 } , { playerId : "PlayerD" , gameId : "G2" , score : 80 } ]) Find the Maximum Three Scores for a Single Game You can use the $maxN accumulator to find the maximum three scores
in a single game. db. gamescores . aggregate ( [ { $match : { gameId : "G1" } } , { $group : { _id : "$gameId" , maxThreeScores : { $maxN : { input : [ "$score" , "$playerId" ] , n : 3 } } } } ] ) The example pipeline: Uses $match to filter the results on a single gameId .
In this case, G1 . Uses $group to group the results by gameId . In this
case, G1 . Specifies the fields that are input for $maxN with input : ["$score","$playerId"] . Uses $maxN to return the maximum three score elements
for the G1 game with n : 3 . The operation returns the following results: [ { _id : 'G1' , maxThreeScores : [ [ 99 , 'PlayerC' ] , [ 33 , 'PlayerB' ] , [ 31 , 'PlayerA' ] ] } ] Finding the Maximum Three Scores Across Multiple Games You can use the $maxN accumulator to find the maximum n scores in each game. db. gamescores . aggregate ( [ { $group : { _id : "$gameId" , maxScores : { $maxN : { input : [ "$score" , "$playerId" ] , n : 3 } } } } ] ) The example pipeline: Uses $group to group the results by gameId . Uses $maxN to return the maximum three score elements
for each game with n: 3 . Specifies the fields that are input for $maxN with input: ["$score","$playerId"] . The operation returns the following results: [ { _id : 'G1' , maxScores : [ [ 99 , 'PlayerC' ] , [ 33 , 'PlayerB' ] , [ 31 , 'PlayerA' ] ] } , { _id : 'G2' , maxScores : [ [ 80 , 'PlayerD' ] , [ 66 , 'PlayerC' ] , [ 14 , 'PlayerB' ] ] } ] Computing n Based on the Group Key for $group You can also assign the value of n dynamically. In this example,
the $cond expression is used on the gameId field. db. gamescores . aggregate ( [ { $group : { _id : { "gameId" : "$gameId" } , gamescores : { $maxN : { input : [ "$score" , "$playerId" ] , n : { $cond : { if : { $eq : [ "$gameId" , "G2" ] } , then : 1 , else : 3 } } } } } } ] ) The example pipeline: Uses $group to group the results by gameId . Specifies the fields that input for $maxN with input : ["$score","$playerId"] . If the gameId is G2 then n is 1, otherwise n is 3. The operation returns the following results: [ { _id : { gameId : 'G2' } , gamescores : [ [ 80 , 'PlayerD' ] ] } , { _id : { gameId : 'G1' } , gamescores : [ [ 99 , 'PlayerC' ] , [ 33 , 'PlayerB' ] , [ 31 , 'PlayerA' ] ] } ] Back $max Next $maxN-array-element
